#!/usr/bin/env node

var docopt = require('docopt');
var tend = require('../');

var doc = [
  'Usage:',
  '  tend',
  '  tend (--help | --version)',
  '  tend [--restart] [--start] [--ignoreHidden] [<dir> <command>] [<filter>]',
  '',
  'Options:',
  '  -h --help          Show this help text',
  '  -v --version       Show tend version information',
  '  -r --restart       If <command> is still running when there is a change, stop and re-run it',
  '  -i --ignoreHidden  Ignore changes to files which start with "."',
  '  -s --start         Run <command> as soon as tend executes',
].join('\r\n');

var args = docopt.docopt(doc, {
  help: true,
  version: 'tend ' + require('../package.json').version,
});

var config = tend.parseConfig();
if (!config && !args['<dir>'] && !args['<command>']) {
  console.error('No .tendrc file found, must run with "<dir> <command>"');
  process.exit(1);
}

if (!config) {
  config = {};
}

if (args['<dir>'] && args['<command>']) {
  config['cli'] = {
    filter: args['<filter>'],
    ignoreHidden: args['--ignoreHidden'],
    restart: args['--restart'],
    start: args['--start'],
    command: args['<command>'],
    directory: args['<dir>'],
  }
}

for (var key in config) {
  console.log('Starting listener: ' + key);
  var options = config[key];
  tend.tend(options.directory, options.command, options);
}
